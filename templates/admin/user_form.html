{% extends "base.html" %}

{% block title %}{% if user %}Kullanıcı Düzenle{% else %}Yeni Kullanıcı{% endif %}{% endblock %}

{% block content %}
<div class="flex flex-col gap-6 lg:flex-row lg:items-end lg:justify-between">
    <div>
        <p class="text-xs uppercase tracking-[0.35em] text-slate-500">Sistem Yönetimi</p>
        <h1 class="mt-3 flex items-center gap-3 text-2xl font-semibold text-slate-100">
            <i class="bi bi-person text-emerald-400"></i>
            {% if user %}Kullanıcı Düzenle{% else %}Yeni Kullanıcı Ekle{% endif %}
        </h1>
        <nav class="mt-3 text-xs text-slate-500">
            <ol class="flex flex-wrap items-center gap-2">
                <li><a href="{{ url_for('dashboard') }}" class="transition hover:text-slate-300">Dashboard</a></li>
                <li class="text-slate-600">/</li>
                <li><a href="{{ url_for('admin_users') }}" class="transition hover:text-slate-300">Kullanıcılar</a></li>
                <li class="text-slate-400">/</li>
                <li class="text-slate-300">{% if user %}Düzenle{% else %}Yeni{% endif %}</li>
            </ol>
        </nav>
    </div>
</div>

<div class="grid gap-8 xl:grid-cols-[minmax(0,1.6fr)_minmax(0,1fr)]">
    <section class="space-y-8">
        <div class="rounded-3xl border border-slate-800/70 bg-slate-950/80 shadow-xl">
            <header class="border-b border-slate-800/60 px-6 py-5">
                <h2 class="flex items-center gap-2 text-sm font-semibold text-slate-200">
                    <i class="bi bi-person-badge text-lg text-emerald-300"></i>
                    Kullanıcı Bilgileri
                </h2>
            </header>
            <div class="px-6 py-6">
                <form method="POST" action="" class="space-y-6">
                    {{ form.hidden_tag() }}

                    <div class="grid gap-6 md:grid-cols-2">
                        <div>
                            {{ form.username.label(class_="text-sm font-medium text-slate-200") }}
                            {{ form.username(class_="mt-2 w-full rounded-2xl border border-slate-800 bg-slate-950/80
                            px-4 py-3 text-sm text-slate-100 transition focus:border-emerald-400 focus:outline-none
                            focus:ring-2 focus:ring-emerald-400/40" + (" border-red-500/60
                            focus:border-red-400 focus:ring-red-400/30" if form.username.errors else "")) }}
                            {% if form.username.errors %}
                            <p class="mt-2 text-sm text-red-300">{% for error in form.username.errors %}{{ error }}{%
                                endfor %}</p>
                            {% endif %}
                        </div>

                        <div>
                            {{ form.full_name.label(class_="text-sm font-medium text-slate-200") }}
                            {{ form.full_name(class_="mt-2 w-full rounded-2xl border border-slate-800 bg-slate-950/80
                            px-4 py-3 text-sm text-slate-100 transition focus:border-emerald-400 focus:outline-none
                            focus:ring-2 focus:ring-emerald-400/40" + (" border-red-500/60 focus:border-red-400
                            focus:ring-red-400/30" if form.full_name.errors else "")) }}
                            {% if form.full_name.errors %}
                            <p class="mt-2 text-sm text-red-300">{% for error in form.full_name.errors %}{{ error }}{%
                                endfor %}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div>
                        {{ form.email.label(class_="text-sm font-medium text-slate-200") }}
                        {{ form.email(class_="mt-2 w-full rounded-2xl border border-slate-800 bg-slate-950/80 px-4 py-3
                        text-sm text-slate-100 transition focus:border-emerald-400 focus:outline-none focus:ring-2
                        focus:ring-emerald-400/40" + (" border-red-500/60 focus:border-red-400 focus:ring-red-400/30" if
                        form.email.errors else "")) }}
                        {% if form.email.errors %}
                        <p class="mt-2 text-sm text-red-300">{% for error in form.email.errors %}{{ error }}{% endfor %}
                        </p>
                        {% endif %}
                    </div>

                    <div class="grid gap-6 md:grid-cols-2">
                        <div>
                            {{ form.password.label(class_="text-sm font-medium text-slate-200") }}
                            {{ form.password(class_="mt-2 w-full rounded-2xl border border-slate-800 bg-slate-950/80
                            px-4 py-3 text-sm text-slate-100 transition focus:border-emerald-400 focus:outline-none
                            focus:ring-2 focus:ring-emerald-400/40" + (" border-red-500/60 focus:border-red-400
                            focus:ring-red-400/30" if form.password.errors else "")) }}
                            {% if form.password.errors %}
                            <p class="mt-2 text-sm text-red-300">{% for error in form.password.errors %}{{ error }}{%
                                endfor %}</p>
                            {% endif %}
                            {% if user %}
                            <p class="mt-2 text-xs text-slate-500">Boş bırakırsanız şifre değişmez.</p>
                            {% endif %}
                        </div>

                        <div>
                            {{ form.password2.label(class_="text-sm font-medium text-slate-200") }}
                            {{ form.password2(class_="mt-2 w-full rounded-2xl border border-slate-800 bg-slate-950/80
                            px-4 py-3 text-sm text-slate-100 transition focus:border-emerald-400 focus:outline-none
                            focus:ring-2 focus:ring-emerald-400/40" + (" border-red-500/60 focus:border-red-400
                            focus:ring-red-400/30" if form.password2.errors else "")) }}
                            {% if form.password2.errors %}
                            <p class="mt-2 text-sm text-red-300">{% for error in form.password2.errors %}{{ error }}{%
                                endfor %}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="grid gap-6 md:grid-cols-2">
                        <div class="rounded-2xl border border-slate-800/80 bg-slate-950/70 px-4 py-4">
                            <label class="flex items-center justify-between text-sm text-slate-300">
                                <span>Admin Yetkisi</span>
                                {{ form.is_admin(class_="peer sr-only") }}
                                <span
                                    class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-800 transition peer-checked:bg-emerald-500/70">
                                    <span
                                        class="absolute left-1 h-4 w-4 rounded-full bg-slate-400 transition peer-checked:translate-x-5 peer-checked:bg-white"></span>
                                </span>
                            </label>
                            <p class="mt-2 text-xs text-slate-500">Adminler tüm yönetim özelliklerine erişebilir.</p>
                        </div>

                        <div class="rounded-2xl border border-slate-800/80 bg-slate-950/70 px-4 py-4">
                            <label class="flex items-center justify-between text-sm text-slate-300">
                                <span>Hesap Aktif</span>
                                {{ form.is_active(class_="peer sr-only") }}
                                <span
                                    class="relative inline-flex h-6 w-11 items-center rounded-full bg-slate-800 transition peer-checked:bg-emerald-500/70">
                                    <span
                                        class="absolute left-1 h-4 w-4 rounded-full bg-slate-400 transition peer-checked:translate-x-5 peer-checked:bg-white"></span>
                                </span>
                            </label>
                            <p class="mt-2 text-xs text-slate-500">Pasif kullanıcılar sisteme giriş yapamaz.</p>
                        </div>
                    </div>

                    <div class="flex flex-wrap gap-3">
                        <button type="submit"
                            class="inline-flex items-center gap-2 rounded-2xl border border-emerald-500/40 bg-emerald-500/10 px-5 py-3 text-sm font-semibold text-emerald-200 transition hover:bg-emerald-500/20">
                            <i class="bi bi-check-circle"></i>
                            {% if user %}Güncelle{% else %}Oluştur{% endif %}
                        </button>
                        <a href="{{ url_for('admin_users') }}"
                            class="inline-flex items-center gap-2 rounded-2xl border border-slate-800 bg-slate-900 px-5 py-3 text-sm font-semibold text-slate-300 transition hover:border-slate-700 hover:text-slate-100">
                            <i class="bi bi-x-circle"></i>
                            İptal
                        </a>
                        {% if user and not user.is_admin %}
                        <button type="button" id="openQuotaModal"
                            class="inline-flex items-center gap-2 rounded-2xl border border-sky-500/40 bg-sky-500/10 px-5 py-3 text-sm font-semibold text-sky-200 transition hover:bg-sky-500/20">
                            <i class="bi bi-flag"></i>
                            Ülkeler &amp; Kotalar
                        </button>
                        {% endif %}
                    </div>
                </form>
            </div>
        </div>

        {% if user and not user.is_admin %}
        <p class="text-sm text-slate-500">Ülke ve kota yönetimi için sağ üstteki “Ülkeler &amp; Kotalar” butonunu
            kullanın.</p>
        {% endif %}
    </section>

    <aside class="space-y-6">
        <div class="rounded-3xl border border-slate-800/70 bg-slate-950/80 p-6">
            <h3 class="flex items-center gap-2 text-sm font-semibold text-slate-200">
                <i class="bi bi-info-circle text-lg text-sky-300"></i>
                {% if user %}Kullanıcı Özeti{% else %}Yeni Kullanıcı Bilgileri{% endif %}
            </h3>
            <div class="mt-5 space-y-4 text-sm text-slate-400">
                {% if not user %}
                <p>Kullanıcı oluşturulduktan sonra ülke kotalarını bu sayfadan tanımlayabilirsiniz.</p>
                <div>
                    <p class="font-medium text-slate-200">Şifre Gereksinimleri</p>
                    <ul class="mt-2 space-y-1 text-xs text-slate-500">
                        <li>En az 8 karakter</li>
                        <li>Bir büyük ve bir küçük harf</li>
                        <li>En az bir rakam</li>
                    </ul>
                </div>
                {% else %}
                <div class="grid gap-3 text-xs text-slate-500">
                    <p><span class="text-slate-300">ID:</span> #{{ user.id }}</p>
                    <p><span class="text-slate-300">Oluşturma:</span> {{ user.created_at.strftime('%d.%m.%Y %H:%M')
                        }}</p>
                    {% if user.last_login %}
                    <p><span class="text-slate-300">Son Giriş:</span> {{ user.last_login.strftime('%d.%m.%Y %H:%M')
                        }}</p>
                    {% endif %}
                </div>
                <p class="text-xs text-slate-500">Admin olmayan kullanıcılara ülke bazlı kotalar atayarak yetkilerini
                    sınırlandırabilirsiniz.</p>
                {% endif %}

                <div>
                    <p class="font-medium text-slate-200">Rol Bilgisi</p>
                    <p class="mt-2 text-xs text-slate-500"><strong class="text-slate-300">Admin:</strong> Tam yetki ve
                        tüm yönetim sayfalarına erişim.</p>
                    <p class="mt-2 text-xs text-slate-500"><strong class="text-slate-300">Kullanıcı:</strong> Sadece
                        kendi randevularını ve atanmış ülkeleri yönetir.</p>
                </div>
            </div>
        </div>
    </aside>
</div>
{% endblock %}

{% block extra_js %}
{% if user and not user.is_admin %}
<script>
    ( function () {
        function initQuotaModal() {
            // Modal HTML'ini oluştur ve body'ye ekle
            const modalHTML = `
<div id="quotaModal" role="dialog" aria-modal="true" aria-labelledby="quotaModalTitle" aria-hidden="true"
    class="fixed inset-0 z-[9999] hidden pointer-events-none">
    <div data-modal-overlay
        class="absolute inset-0 bg-slate-950/80 backdrop-blur-sm opacity-0 transition-opacity duration-200 ease-out">
    </div>
    <div class="relative mx-auto flex min-h-full w-full max-w-3xl items-center justify-center px-4 py-10 sm:py-16">
        <div data-modal-panel
            class="w-full transform rounded-3xl border border-slate-800/80 bg-slate-950/95 shadow-2xl transition-all duration-200 ease-out opacity-0 translate-y-4 scale-95">
            <div class="flex items-center justify-between border-b border-slate-800/80 px-6 py-4">
                <div>
                    <p class="text-xs uppercase tracking-[0.35em] text-slate-500">Ülke Yönetimi</p>
                    <h3 id="quotaModalTitle" class="text-lg font-semibold text-slate-100">Ülkeler &amp; Kota Atamaları
                    </h3>
                </div>
                <button id="closeQuotaModal" type="button"
                    class="inline-flex h-10 w-10 items-center justify-center rounded-xl border border-slate-800 bg-slate-900 text-slate-300 transition hover:text-slate-100">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>
            <div class="space-y-6 px-6 py-6">
                <form id="quotaForm" method="POST" action="{{ url_for('admin_quota_add', user_id=user.id) }}"
                    class="grid gap-4 md:grid-cols-[minmax(0,1.4fr)_minmax(0,1fr)_auto]">
                    {{ quota_form.hidden_tag() }}
                    <div>
                        {{ quota_form.country_id.label(class_="text-sm font-medium text-slate-200") }}
                        {{ quota_form.country_id(class_="mt-2 w-full rounded-2xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-slate-100 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-400/40") }}
                    </div>
                    <div>
                        {{ quota_form.quota_limit.label(class_="text-sm font-medium text-slate-200") }}
                        {{ quota_form.quota_limit(class_="mt-2 w-full rounded-2xl border border-slate-800 bg-slate-950/80 px-4 py-3 text-sm text-slate-100 focus:border-sky-400 focus:outline-none focus:ring-2 focus:ring-sky-400/40") }}
                    </div>
                    <div class="flex items-end">
                        <button type="submit"
                            class="inline-flex items-center gap-2 rounded-2xl border border-emerald-500/40 bg-emerald-500/10 px-4 py-3 text-sm font-semibold text-emerald-200 transition hover:bg-emerald-500/20">
                            <i class="bi bi-plus-circle"></i>
                            Kaydet
                        </button>
                    </div>
                </form>

                <div id="quotaTableContainer">
                    {% include 'admin/partials/quota_table.html' %}
                </div>

                <div class="rounded-2xl border border-slate-800/70 bg-slate-900/60 px-4 py-3 text-xs text-slate-500">
                    <p>Bu modal yalnızca danışman kullanıcılar için görünür. Ülke kota limitleri danışmanların randevu
                        oluşturma haklarını sınırlamak için kullanılır.</p>
                </div>
            </div>
        </div>
    </div>
</div>
            `;

            // Modal'ı body'ye ekle
            if ( !document.getElementById( 'quotaModal' ) ) {
                document.body.insertAdjacentHTML( 'beforeend', modalHTML );
            }

            const quotaModal = document.getElementById( 'quotaModal' );
            if ( !quotaModal ) {
                return;
            }

            const quotaOverlay = quotaModal.querySelector( '[data-modal-overlay]' );
            const quotaPanel = quotaModal.querySelector( '[data-modal-panel]' );
            const openQuotaModalBtn = document.getElementById( 'openQuotaModal' );
            const closeQuotaModalBtn = document.getElementById( 'closeQuotaModal' );
            const quotaForm = document.getElementById( 'quotaForm' );
            const quotaTableContainer = document.getElementById( 'quotaTableContainer' );
            const modalTransitionMs = 200;
            const modalQueryParam = 'modal';
            const modalQueryValue = 'quotas';

            let lastFocusedElement = null;
            let closeModalTimeout;

            function setModalQueryState( isOpen ) {
                if ( !window.history || typeof window.history.replaceState !== 'function' ) {
                    return;
                }

                const url = new URL( window.location.href );
                const current = url.searchParams.get( modalQueryParam );

                if ( isOpen ) {
                    if ( current === modalQueryValue ) {
                        return;
                    }
                    url.searchParams.set( modalQueryParam, modalQueryValue );
                } else {
                    if ( current !== modalQueryValue ) {
                        return;
                    }
                    url.searchParams.delete( modalQueryParam );
                }

                window.history.replaceState( window.history.state, '', url );
            }

            function toggleBodyScroll( disable ) {
                if ( disable ) {
                    document.body.dataset.modalOpen = 'true';
                    document.body.style.overflow = 'hidden';
                    const scrollBarWidth = window.innerWidth - document.documentElement.clientWidth;
                    if ( scrollBarWidth > 0 ) {
                        document.body.style.paddingRight = `${scrollBarWidth}px`;
                    }
                } else {
                    delete document.body.dataset.modalOpen;
                    document.body.style.overflow = '';
                    document.body.style.paddingRight = '';
                }
            }

            function animateModal( show ) {
                if ( show ) {
                    quotaOverlay?.classList.add( 'opacity-100' );
                    quotaPanel?.classList.add( 'opacity-100', 'translate-y-0', 'scale-100' );
                } else {
                    quotaOverlay?.classList.remove( 'opacity-100' );
                    quotaPanel?.classList.remove( 'opacity-100', 'translate-y-0', 'scale-100' );
                }
            }

            function openQuotaModal() {
                if ( closeModalTimeout ) {
                    clearTimeout( closeModalTimeout );
                    closeModalTimeout = undefined;
                }

                lastFocusedElement = document.activeElement instanceof HTMLElement ? document.activeElement : null;

                quotaModal.setAttribute( 'aria-hidden', 'false' );
                quotaModal.classList.remove( 'hidden', 'pointer-events-none' );
                quotaModal.classList.add( 'pointer-events-auto' );

                requestAnimationFrame( () => {
                    animateModal( true );
                } );

                toggleBodyScroll( true );
                setModalQueryState( true );

                if ( quotaPanel ) {
                    quotaPanel.setAttribute( 'tabindex', '-1' );
                    quotaPanel.focus( { preventScroll: true } );
                }
            }

            function closeQuotaModal( options = {} ) {
                const { updateHistory = true } = options;

                animateModal( false );
                quotaModal.classList.remove( 'pointer-events-auto' );
                quotaModal.classList.add( 'pointer-events-none' );
                quotaModal.setAttribute( 'aria-hidden', 'true' );

                toggleBodyScroll( false );

                closeModalTimeout = window.setTimeout( () => {
                    quotaModal.classList.add( 'hidden' );
                    if ( quotaPanel ) {
                        quotaPanel.removeAttribute( 'tabindex' );
                    }
                    if ( lastFocusedElement && typeof lastFocusedElement.focus === 'function' ) {
                        lastFocusedElement.focus( { preventScroll: true } );
                    }
                    closeModalTimeout = undefined;
                }, modalTransitionMs );

                if ( updateHistory ) {
                    setModalQueryState( false );
                }
            }

            // ISO 3166-1 alpha-3 to alpha-2 dönüşümü
            const alpha3ToAlpha2 = {
                'USA': 'US', 'GBR': 'GB', 'DEU': 'DE', 'FRA': 'FR', 'ITA': 'IT', 'ESP': 'ES',
                'CAN': 'CA', 'AUS': 'AU', 'JPN': 'JP', 'KOR': 'KR', 'CHN': 'CN', 'IND': 'IN',
                'BRA': 'BR', 'MEX': 'MX', 'RUS': 'RU', 'TUR': 'TR', 'SAU': 'SA', 'ARE': 'AE',
                'EGY': 'EG', 'ZAF': 'ZA', 'NGA': 'NG', 'ARG': 'AR', 'CHL': 'CL', 'COL': 'CO',
                'PER': 'PE', 'NLD': 'NL', 'BEL': 'BE', 'CHE': 'CH', 'AUT': 'AT', 'SWE': 'SE',
                'NOR': 'NO', 'DNK': 'DK', 'FIN': 'FI', 'POL': 'PL', 'CZE': 'CZ', 'HUN': 'HU',
                'ROU': 'RO', 'BGR': 'BG', 'GRC': 'GR', 'PRT': 'PT', 'IRL': 'IE', 'ISL': 'IS',
                'HRV': 'HR', 'SRB': 'RS', 'UKR': 'UA', 'SGP': 'SG', 'MYS': 'MY', 'THA': 'TH',
                'VNM': 'VN', 'IDN': 'ID', 'PHL': 'PH', 'NZL': 'NZ', 'ISR': 'IL', 'PAK': 'PK',
                'BGD': 'BD', 'IRN': 'IR', 'IRQ': 'IQ', 'KWT': 'KW', 'QAT': 'QA', 'OMN': 'OM',
                'JOR': 'JO', 'LBN': 'LB', 'MAR': 'MA', 'DZA': 'DZ', 'TUN': 'TN', 'LBY': 'LY',
                'KEN': 'KE', 'ETH': 'ET', 'GHA': 'GH'
            };

            function loadCountryFlags() {
                // Kota tablosundaki bayrak görsellerini yükle
                document.querySelectorAll( '.country-flag' ).forEach( img => {
                    const code = img.getAttribute( 'data-country-code' );
                    if ( code ) {
                        const alpha2 = alpha3ToAlpha2[code] || code.substring( 0, 2 );
                        img.src = `https://flagcdn.com/48x36/${alpha2.toLowerCase()}.png`;
                        img.srcset = `https://flagcdn.com/96x72/${alpha2.toLowerCase()}.png 2x`;
                    }
                } );
            }

            function bindQuotaActions() {
                if ( !quotaTableContainer ) return;

                // Bayrak görsellerini yükle
                loadCountryFlags();

                quotaTableContainer.querySelectorAll( '.delete-quota-btn' ).forEach( button => {
                    button.addEventListener( 'click', () => {
                        const userId = button.getAttribute( 'data-user-id' );
                        const quotaId = button.getAttribute( 'data-quota-id' );
                        if ( !userId || !quotaId ) return;

                        fetch( `/admin/users/${userId}/quotas/${quotaId}/delete`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        } )
                            .then( response => response.json() )
                            .then( data => {
                                if ( data.success ) {
                                    quotaTableContainer.innerHTML = data.html;
                                    bindQuotaActions();
                                    showAlert( 'success', data.message );
                                } else {
                                    showAlert( 'danger', data.message );
                                }
                            } )
                            .catch( error => showAlert( 'danger', 'Kota silinirken bir hata oluştu: ' + error ) );
                    } );
                } );
            }

            if ( quotaForm ) {
                quotaForm.addEventListener( 'submit', event => {
                    event.preventDefault();
                    const action = quotaForm.getAttribute( 'action' );
                    const formData = new FormData( quotaForm );

                    fetch( action, {
                        method: 'POST',
                        body: formData
                    } )
                        .then( response => response.json() )
                        .then( data => {
                            if ( data.success ) {
                                quotaTableContainer.innerHTML = data.html;
                                quotaForm.reset();
                                bindQuotaActions();
                                showAlert( 'success', data.message );
                            } else {
                                showAlert( 'danger', data.message );
                            }
                        } )
                        .catch( error => showAlert( 'danger', 'Kota eklenirken bir hata oluştu: ' + error ) );
                } );
            }

            openQuotaModalBtn?.addEventListener( 'click', () => openQuotaModal() );
            closeQuotaModalBtn?.addEventListener( 'click', () => closeQuotaModal() );

            quotaOverlay?.addEventListener( 'click', event => {
                if ( event.target === quotaOverlay ) {
                    closeQuotaModal();
                }
            } );

            quotaModal.addEventListener( 'click', event => {
                if ( event.target === quotaModal ) {
                    closeQuotaModal();
                }
            } );

            document.addEventListener( 'keydown', event => {
                if ( event.key === 'Escape' && !quotaModal.classList.contains( 'hidden' ) ) {
                    closeQuotaModal();
                }
            } );

            window.addEventListener( 'popstate', () => {
                const url = new URL( window.location.href );
                if ( url.searchParams.get( modalQueryParam ) === modalQueryValue ) {
                    openQuotaModal();
                } else if ( !quotaModal.classList.contains( 'hidden' ) ) {
                    closeQuotaModal( { updateHistory: false } );
                }
            } );

            bindQuotaActions();

            const shouldOpenQuotaModal = "{{ 'true' if open_quota_modal else 'false' }}" === 'true';
            if ( shouldOpenQuotaModal ) {
                openQuotaModal();
            }
        }

        if ( document.readyState === 'loading' ) {
            document.addEventListener( 'DOMContentLoaded', initQuotaModal );
        } else {
            initQuotaModal();
        }
    } )();
</script>
{% endif %}
{% endblock %}